\chapter{АРХИТЕКТУРА СИСТЕМЫ}
%\chapter{Архитектура системы}

\section{Выделение концептуальной модели данных}

%TODO нормальное определение лиать
Топологией  сети называют множество узлов сети и соединений между ними. 

В зависимости от моделируемого аспекта, топологии сети классифицируют на:
\begin{itemize}
    \item физические
    \item логические
\end{itemize}

По способу соединения узлов выделяют следующие топологии:
\begin{itemize}
    \item шина
    \item звезда
    \item кольцо
    \item mesh %TODO как этта парусске?
\end{itemize}

Физическая топология описывает взаиморасположение физических узлов сети и их соединений в 
пространстве. Соединения между узлами иногда называют физическим носителем.

Разработка правильной физической топологии -- сложный и ответственный процесс.
Ошибки на этом этапе всегда ведут к большим затратам на перепроектирование и повторное 
введение в эксплуатацию. Так же, от выбора топологии зависит сложность расширения
сети.

Логическая топология в свою очередь является проекцией логических потоков данных
в системе. Так, один узел или связь физической топологии может представлять собой несколько 
логических узлов, и наоборот. В примитивных случаях логическая и физическая топология 
совпадают с точностью до изоморфизма, в более сложных -- могут значительно отличаться.
При этом, в отличии от физической топологии, логическая топология отличается намного
большей гибкостью, так как легко подвержена модификации посредством простого
изменения конфигурационных параметров узлов физической топологии, перемещением
узлов логической топологии между физическими и т.д.

Физические носители можно классифицировать на проводные и беспроводные. В первом случае
предполагается существование некоторой закрытой физической среды, обладающей
специфическими характеристиками. Во втором же случае физическая среда не является замкнутой.

За передачу данных по физическому носителю отвечает физический уровень модели OSI.
Информация на этом слое передается побитово, а протоколы отвечают за кодирование и
декодирование потока бит в те или иные физические сигналы. Протоколы этого уровня 
так же регламентируют требования к параметрам среды передачи и физические интерфейсы.

Каждый узел физической топологии обладает некоторым набором разъемов определенных
стандартов, которые разведены на соответствующем сетевом адаптере (сетевой карте).
Сетевой адаптер может содержать как порты только одного стандарта, так и
порты разных стандартов. В качестве примера первых можно привести большинство сетевых карт 
PC-совместимых  компьютеров, в качестве вторых -- сетевые модули Cisco EtherSwitch, имеющие 
несколько портов Ethernet 10/100 и один порт GigabitEthernet.\cite{cisco-etherswitch}

Что касается узлов топологии, то их характеристики можно разделить на три группы: 
характеристики аппаратного обеспечения, 
набор ПО, которое на нем запущено, 
и настройки этого ПО.
Характеристики аппаратного обеспечения определяются набором модулей, из которого
состоит конкретный физический узел сети. В зависимости от этого набора на узле
может быть запущено определенное множество операционных систем и прикладных программ.

Для того, чтобы понять общие требования к моделированию топологий, рассмотрим
пример типичного трехзвенного приложения.
На рис.~\ref{fig:physical-topology-ex} показана физическая топология типа "звезда", состоящая
из маршрутизатора, 
трех серверов базы данных, 
трех серверов приложений, 
кэширующим сервером, 
клиента, обращающегося к приложению из локальной сети, 
и клиента, работающего с  приложением через WAN.
При этом логическая топология, показанная на рис.~\ref{fig:logical-topology-ex} существенно отличается от физической.

\begin{figure}
  \centering
  {\small\input{fig/physical-topology-ex}}
  \caption{Физическая топология трехзвенного приложения}
  \label{fig:physical-topology-ex}
\end{figure} 

\begin{figure}
  \centering
  {\small\input{fig/logical-topology-ex}}
  \caption{Логическая топология трехзвенного приложения}
  \label{fig:logical-topology-ex}
\end{figure} 

Стоит отметить, что полученную логическую топологию можно разделить на несколько
сегментов:
\begin{itemize}
    \item mesh-сеть между участниками кластера баз данных
    \item топологию "звезда" между лидером кластера базы данных и серверами приложений
    \item топологию "звезда" между серверами приложений и кэширующим сервером
    \item топологию "звезда" между кэширующим сервером и клиентами
\end{itemize}

Хоть способ соединения узлов логической топологи рассмотренного примера продиктован 
самой природой этих узлов, тем не менее, расположение узлов логической топологии
на конкретных узлах физической может быть изменено, к примеру, с целью отдать более
мощную ЭВМ для более загруженного звена приложения.

Физическая же топология в данном случае ограничена ограничениями участвующего оборудования.
В частности, последующее горизонтальное масштабирование посредством добавления
новых узлов может быть осложнено количеством физических портов на коммутаторе, 
пропускной способностью самого коммутатора и пропускной способностью сетевых устройств
вычислительных узлов. Особенное внимание в таких случаях необходимо уделять именно
сетевому оборудованию, так как работы по изменению физической топологии, затрагивающие
эти узлы, влекут за собой остановку всех потоков данных, идущих через них.

Так ошибки при проектировании физических топологий приносят больше всего трудностей, 
то наибольший смысл имеет моделирование именно физических топологий.
В силу того, что моделируемые процессы зависят от большого числа факторов, 
среди которых есть и случайные, единственным подходящим методом является 
имитационное моделирование.
%TODO ссылка на шавенько

При этом составление упрощенной модели всего сетевого стека операционной системы и 
работающих внутри нее программ является нецелесообразным, в силу большого количества
параметров системы и наличия сложных связей между элементами системы. Гораздо более
перспективным в данном случае является использование виртуализации. Саму по себе, 
виртуализацию аппаратного обеспечения так же можно отнести к имитационному моделированию,
при котором входными параметрами являются свойства моделируемого аппаратного обеспечения
и данные, хранимые на виртуальных накопителях виртуализируемой машины.

\section{Формальное описание модели}

Формальное описание сетевой топологии, можно разделить на две части:
картотека сущностей и граф конкретных сущностей. 
Набор сущностей и их взаимосвязей при этом обязан соответствовать набору ограничений.

Картотека сущностей и ограничений состоит из:
\begin{itemize}
    \item множество типов соединений $T_L$
    \item множество типов узлов $T_N$
    \item множество типов сетевых адаптеров $T_A$
    \item множество протоколов $P$
    \item множество наборов ПО $S$
    \item правила совместимости платформ и сетевых адаптеров $C_A$
    \item правила совместимости платформ и ПО $C_S$
\end{itemize}

Элементами множества типов соединений являются поддерживаемые в рамках картотеки
протоколы физического уровня модели OSI. Для каждого типа определен набор параметров
соединения $D_L$, а так же количество портов $k$, которое может быть соединено при помощи этого.
типа связи. К примеру, при помощи оптического канала связи можно соединить только два порта,
при помощи ethernet -- два и более. 
%TODO check
$$ t_L = (k, D_L) $$ 

Множество $N$ задает набор всех возможных типов узлов, которые могут быть включены в 
топологию. Тип узла имеет специфический для него связанный с ним набор параметров $D_N$,
некоторое количество портов $b$ для подключения сетевых адаптеров, 
а так же список сетевых адаптеров, подключенных по умолчанию $A^0$.
%TODO check
$$ n_L = \{ (D_N, B, A^0) \} $$

Совместимость платформ и сетевых адаптеров задается отношением, ставящим в соответствие 
каждому аппаратному порту типа узла набор подходящих типов сетевых адаптеров.
%TODO check
$$ C_A = \{ ((n, b), a_{(n, b)}) | n = (d, b, a^0) \in T_N, a_{(n, b)} \in A_{(n, b)} \subset A \} $$

Совместимость платформ и ПО представляет собой соответствие между платформой и набором
работающих на этой платформе наборов ПО.
$$ C_S = \{ (n, s) | n \in T_N, s \in S \} $$

Граф конкретных сущностей $G$ состоит из 
набора узлов $E_N$ и набора связей между ними $V_L$. 
С каждый узлом ассоциирован его тип $t$, набор подключенных сетевых адаптеров 
$A_e = \{(i, a)| a \in T_A, i \in N, ((t, i), a) \in C_A\}$, запущенное ПО $s_e$ и 
набор значений специфических для типа параметров $P_e$. 
Связи между узлами задаются множеством подключенных портов узлов $p$ 
и набором значений параметров для этого типа соединения $P_v$.
\begin{eqnarray}
    G &=& (E_N, V_L) \\
    E_N &=& \{ (t, A_e, s_e) | t \in T_N,  
                                          s_e \in S,  
                                          (t,s) \in C_A\} \\
    V_N &=& \{ (p, P_v) | p = (e, i), e \in E_N, i < k = e_{0,0} \}    
\end{eqnarray}

\section{Компоненты моделирующего программного комплекса}

Возвращаясь к примеру трехзвенного приложения, стоит отметить, что одновременный запуск
даже этого несложного случая требует достаточно больших вычислительных ресурсов.
Для запуска данной модели на одной машине потребуется ЭВМ с примерно 10 Гб оперативной
памяти и шестью вычислительными ядрами, из расчета одного гигабайта памяти и 50\%-ной
загрузки процессора виртуальной машиной.

Классическим выходом из этой ситуации является покупка более мощной машины для запуска
этой модели. Но данный подход имеет и свои минусы -- цена на ресурсы при вертикальном
масштабировании вырастает экспоненциально, вследствие чего моделирование при 
проектировании более сложных сетей может оказаться экономически нецелесообразным.

Современный подход к решению этой проблемы -- так называемое горизонтальное 
масштабирование, при котором одну мощную машину заменяют большим количеством
менее мощных машин, разделяя выполняемую задачу между ними.

Использование большого количества машин, выделяя их мощности на временной основе для
выполнения какой-либо задачи, запрошенной клиентом, является классическим вариантом
облачной системы, конкретно --  IaaS-облака.
Таким образом, создание системы моделирования сетей на базе виртуализации 
аппаратного обеспечения является частным случаем создания IaaS-платформы.

На самом высоком уровне, IaaS-платформу можно разделить на три части: 
подсистема прикладного программного интерфейса, отвечающий на команды пользователя,
подсистему хранения данных и вычислительную подсистему (см. рис.~\ref{fig:iaas-birdsview}).
\begin{figure}
  \centering
  {\small\input{fig/iaas-birdsview}}
  \caption{Высокоуровневая архитектура IaaS}
  \label{fig:iaas-birdsview}
\end{figure} 

В силу того, что IaaS платформа может быть использована удаленно, прикладной программный
интерфейс как правило реализован на основе стека TCP/IP. Современный подход рекомендует
при создании протоколов использовать текстовое представление вместо бинарного, так как
это облегчает создание клиентских приложений и отладку в случае возникновения проблем.

Все, за что отвечает подсистема прикладного программного интерфейса -- взаимодействие
с клиентскими программами пользователя и отправка запросов к нижележащим подсистемам
хранения данных и вычислений. На этом слое обычно реализуется базовая авторизация и 
аутентификация, защита от злонамеренных действий. %TODO дополнить

Подсистему хранения данных можно логически разделить на две части: хранение образов
операционных систем и хранение данных запущенных виртуальных машин.
При этом последняя часть может не выделяться в отдельную подсистему, что позволяет
упростить развернутую платформу, если не требуется обеспечить специфических 
требований к хранению данных виртуальных машин.

Вся логика управления ресурсами реализуется на уровне вычислительной подсистемы.
Эту логику можно декомпозировать в несколько подсистем:
\begin{itemize}
    \item подсистема планировки ресурсов
    \item подсистема сетевого взаимодействия
    \item подсистема виртуализации
\end{itemize}
Планировщик ресурсов отвечает за распределение нагрузки по вычислительным узлам
системы. Для этого могут использованы различные алгоритмы, от простого round robin,
до сложной логики, учитывающей индивидуальную статистику по загрузке узлов.

Подсистема сетевого взаимодействия отвечает за настройку соединения между запущенными 
виртуальными машинами. Так же как правило здесь обеспечивается маршрутизация
с внешними по отношению к системе сетями, изоляция между виртуальными машинами
разных пользователей и разных сеансов одного пользователя, QoS и другие аспекты.

Подсистема виртуализации отвечает за реализацию предназначения системы.
При поддержке других подсистем, она запускает и останавливает виртуальные машины, 
обеспечивает изоляцию между машинами на одном физическом узле. 
Логическая топология IaaS-платформы с учетом проведенной декомпозиции показана на рис.~\ref{fig:iaas-lowlevel}
\begin{figure}
  \centering
  {\footnotesize\input{fig/iaas-lowlevel}}
  \caption{Подробная архитектура IaaS}
  \label{fig:iaas-lowlevel}
\end{figure} 
